<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GT Marketplace - User Panel</title>
    <style>
        /* ...existing CSS (tidak diubah)... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
        }
        .header h1 { color: #4a5568; font-size: 2.5em; margin-bottom: 10px; }
        .wl-balance {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #744210;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            display: inline-block;
            margin-top: 15px;
        }
        .deposit-btn {
            background: linear-gradient(45deg,#48bb78,#38a169);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-top: 18px;
            margin-right: 10px;
            display: inline-block;
        }
        .deposit-btn:hover {
            background: linear-gradient(45deg,#38a169,#2f855a);
            transform: translateY(-2px);
        }
        .logout-btn {
            background: linear-gradient(45deg, #e53e3e, #c53030);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-block;
            margin-top: 18px;
        }
        .logout-btn:hover {
            background: linear-gradient(45deg, #c53030, #a81d1d);
            transform: translateY(-2px);
        }
        .products-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .section-title {
            font-size: 1.8em;
            color: #2d3748;
            margin-bottom: 25px;
            text-align: center;
        }
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }
        .product-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }
        .product-image {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-bottom: 15px;
        }
        .product-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }
        .product-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .product-price {
            background: linear-gradient(45deg, #ffd700, #ffed4a);
            color: #744210;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .product-stock {
            color: #48bb78;
            font-weight: bold;
            font-size: 0.9em;
        }
        .add-cart-btn {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
        }
        .add-cart-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #38a169, #2f855a);
            transform: translateY(-2px);
        }
        .add-cart-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .cart-section {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        .cart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }
        .cart-title {
            font-size: 1.5em;
            color: #2d3748;
            font-weight: bold;
        }
        .cart-count {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .cart-items {
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }
        .cart-item-info { flex: 1; }
        .cart-item-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 0.9em;
        }
        .cart-item-details {
            color: #718096;
            font-size: 0.8em;
            margin-top: 2px;
        }
        .cart-item-remove {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .cart-item-remove:hover { background: #c53030; }
        .cart-summary {
            border-top: 2px solid #e2e8f0;
            padding-top: 15px;
            display: block;
        }
        .cart-total {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .total-amount {
            font-size: 1.2em;
            color: #744210;
            background: #fffbe6;
            padding: 6px 14px;
            border-radius: 15px;
            font-weight: bold;
            display: inline-block;
        }
        .checkout-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        .checkout-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #5a67d8, #6b46c1);
            transform: translateY(-2px);
        }
        .checkout-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .empty-cart {
            color: #718096;
            text-align: center;
            padding: 20px;
        }
        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 9999;
            padding: 18px 32px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            animation: slideInRight 0.4s;
            box-shadow: 0 4px 16px rgba(0,0,0,0.13);
        }
        @keyframes slideInRight {
            from { right: -300px; opacity: 0; }
            to { right: 30px; opacity: 1; }
        }
        .notification.success { background: #38a169; }
        .notification.error { background: #e53e3e; }
        .history-section {
            grid-column: 1 / -1;
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }
        #historyTable table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #historyTable th, #historyTable td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: center;
        }
        #historyTable th {
            background: #f7fafc;
            color: #4a5568;
        }
        /* ...modal deposit, responsive, dll... */
        @media (max-width: 900px) {
            .container { grid-template-columns: 1fr; }
            .cart-section { position: static; top: unset; }
        }
    </style>
    <script>
    if (!localStorage.getItem('gt_session')) {
        window.location = "login.html";
    } else {
        const session = JSON.parse(localStorage.getItem('gt_session'));
        if (session.isAdmin) window.location = "index.html";
    }
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GT Marketplace</h1>
            <div style="margin-bottom:10px;">
                <span id="growid" style="font-weight:bold;"></span>
            </div>
            <div class="wl-balance" id="wlBalance">💎 Saldo: 0 WL</div>
            <br>
            <button class="deposit-btn" id="depositBtn">💰 Deposit</button>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
        <div class="products-section">
            <div class="section-title">Produk Tersedia</div>
            <div class="products-grid" id="productsGrid"></div>
        </div>
        <div class="cart-section">
            <div class="cart-header">
                <span class="cart-title">Keranjang</span>
                <span class="cart-count" id="cartCount">0</span>
            </div>
            <div class="cart-items" id="cartItems"></div>
            <div class="cart-summary" id="cartSummary" style="display:none;">
                <div class="cart-total">Total:</div>
                <div class="total-amount" id="totalAmount">💎 0 WL</div>
                <button class="checkout-btn" id="checkoutBtn" disabled>💳 Checkout</button>
            </div>
        </div>
        <div class="history-section">
            <div class="section-title">History Pembelian (Global)</div>
            <div id="historyTable"></div>
        </div>
    </div>

    <!-- Modal Deposit -->
    <div id="depositModal" style="display:none;">
      <div class="modal-content">
        <!-- ...modal deposit... -->
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="js/supabase.js"></script>
    <script>
    const session = JSON.parse(localStorage.getItem('gt_session'));
    document.getElementById('growid').textContent = session.growid;

    function logout() {
        localStorage.removeItem('gt_session');
        window.location = "login.html";
    }

    let products = [];
    let cart = { qty: 0 };
    let hargaGmail = 0;
    let userBalance = 0;

    async function fetchUserBalance() {
        const { data } = await supabase
            .from('users')
            .select('balance')
            .eq('growid', session.growid)
            .maybeSingle();
        if (data && typeof data.balance === 'number') {
            userBalance = data.balance;
            document.getElementById('wlBalance').textContent = `💎 Saldo: ${userBalance} WL`;
        } else {
            document.getElementById('wlBalance').textContent = `💎 Saldo: 0 WL`;
        }
    }

    async function fetchHargaGmail() {
        const { data } = await supabase
            .from('settings')
            .select('value')
            .eq('key', 'harga_gmail')
            .maybeSingle();
        if (data && data.value) {
            hargaGmail = parseInt(data.value, 10);
        } else {
            hargaGmail = 0;
        }
    }

    async function fetchProducts() {
        const { data, error } = await supabase
            .from('stock_items')
            .select('*')
            .eq('status', 'available');
        if (error || !data || data.length === 0) {
            products = [{
                image: "📧",
                label: "Gmail Fresh",
                price: hargaGmail,
                stock: 0
            }];
        } else {
            products = [{
                image: "📧",
                label: "Gmail Fresh",
                price: hargaGmail,
                stock: data.length
            }];
        }
        renderProducts();
    }

    function renderProducts() {
        const grid = document.getElementById('productsGrid');
        const product = products[0];
        if (!product || product.stock === 0) {
            grid.innerHTML = '<div style="text-align: center; color: #718096; grid-column: 1 / -1; padding: 40px;">Tidak ada Gmail stock tersedia</div>';
            return;
        }
        grid.innerHTML = `
            <div class="product-card">
                <div class="product-image">${product.image}</div>
                <div class="product-name">${product.label}</div>
                <div class="product-info">
                    <div class="product-price">💎 ${product.price} WL</div>
                    <div class="product-stock">Stock: ${product.stock}</div>
                </div>
                <div style="margin-bottom:10px;">
                    <input type="number" id="qtyInput" min="1" max="${product.stock}" value="${cart.qty || 1}" style="width:60px;padding:5px;border-radius:6px;border:1px solid #e2e8f0;">
                    <span style="font-size:0.95em;color:#888;">Jumlah</span>
                </div>
                <button class="add-cart-btn" onclick="addToCart()" ${product.stock === 0 ? 'disabled' : ''}>
                    ${cart.qty > 0 ? 'Update Keranjang' : (product.stock === 0 ? '❌ Habis' : '🛒 Tambah ke Keranjang')}
                </button>
            </div>
        `;
        document.getElementById('qtyInput').addEventListener('input', function() {
            if (this.value < 1) this.value = 1;
            if (this.value > product.stock) this.value = product.stock;
        });
    }

    function addToCart() {
        const qty = parseInt(document.getElementById('qtyInput').value, 10) || 1;
        const product = products[0];
        if (!product || product.stock === 0) {
            showNotification('Produk tidak ditemukan atau sudah habis.', 'error');
            return;
        }
        if (qty > product.stock) {
            showNotification('Jumlah melebihi stock!', 'error');
            return;
        }
        if (qty * hargaGmail > userBalance) {
            showNotification('Saldo tidak cukup!', 'error');
            return;
        }
        cart = { ...product, qty };
        updateCartDisplay();
        renderProducts();
        showNotification(`${product.label} (${qty}x) ditambahkan ke keranjang!`, 'success');
    }

    function removeFromCart() {
        cart = { qty: 0 };
        updateCartDisplay();
        renderProducts();
        showNotification('Item dihapus dari keranjang', 'success');
    }

    function updateCartDisplay() {
        const cartItems = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        const cartSummary = document.getElementById('cartSummary');
        const totalAmount = document.getElementById('totalAmount');
        if (!cart.qty || cart.qty === 0) {
            cartItems.innerHTML = '<div class="empty-cart">Keranjang masih kosong</div>';
            cartSummary.style.display = 'none';
            cartCount.textContent = '0';
            return;
        }
        let total = cart.qty * hargaGmail;
        cartItems.innerHTML = `
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-name">${cart.image} ${cart.label}</div>
                    <div class="cart-item-details">${cart.qty}x @ ${cart.price} WL = ${total} WL</div>
                </div>
                <button class="cart-item-remove" onclick="removeFromCart()">×</button>
            </div>
        `;
        cartCount.textContent = cart.qty;
        totalAmount.textContent = `💎 ${total} WL`;
        cartSummary.style.display = 'block';
        const checkoutBtn = document.getElementById('checkoutBtn');
        if (total > userBalance) {
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = '💳 Saldo Tidak Cukup';
        } else {
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = '💳 Checkout';
        }
    }

    document.getElementById('checkoutBtn').addEventListener('click', async () => {
        if (!cart.qty || cart.qty === 0) return;
        const total = cart.qty * hargaGmail;
        if (total > userBalance) {
            showNotification('Saldo World Lock tidak mencukupi!', 'error');
            return;
        }
        const jumlah = cart.qty;
        const res = await fetch('/.netlify/functions/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ growid: session.growid, jumlah })
        });
        let data;
        try {
            data = await res.json();
        } catch {
            const text = await res.text();
            data = { success: false, message: text };
        }
        if (data.success) {
            showNotification('Barang sudah dikirim ke email Anda!', 'success');
            cart = { qty: 0 };
            updateCartDisplay();
            fetchHistory();
            fetchUserBalance();
            fetchProducts();
        } else {
            showNotification('Gagal checkout: ' + (data.message || data.body || ''), 'error');
        }
    });

    async function fetchHistory() {
        const { data, error } = await supabase
            .from('daily_sales')
            .select('*')
            .order('tanggal', { ascending: false });
        const historyTable = document.getElementById('historyTable');
        if (error || !data || data.length === 0) {
            historyTable.innerHTML = '<div style="color:#718096;text-align:center;padding:20px;">Belum ada history pembelian.</div>';
            return;
        }
        historyTable.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>GrowID</th>
                        <th>Tanggal</th>
                        <th>Jumlah</th>
                        <th>Harga/Item</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(row => `
                        <tr>
                            <td>${row.growid || '-'}</td>
                            <td>${new Date(row.tanggal).toLocaleString()}</td>
                            <td>${row.jumlah}</td>
                            <td>${row.harga} WL</td>
                            <td>${row.total} WL</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    function showNotification(message, type) {
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) existingNotification.remove();
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }

    (async function() {
        await fetchUserBalance();
        await fetchHargaGmail();
        await fetchProducts();
        updateCartDisplay();
        fetchHistory();
    })();

    // === SUPABASE REALTIME (opsional, tidak diubah) ===
    // ...realtime saldo user & stock...

    // === DEPOSIT MODAL & CAPTCHA MATEMATIKA (tidak diubah) ===
    // ...deposit modal...
    </script>
</body>
</html>